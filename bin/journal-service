#!/usr/bin/env ruby

require_relative "lib/helpers"

class JournalService
  def self.call = new(ARGV).call

  def initialize(argv)
    @argv = argv
  end

  def call
    if has_journalfmt?
      command("journalctl --output=json #{additional_args} --unit=#{service_name} | #{journalfmt}")
    else
      command("journalctl #{additional_args} #{service_name}")
    end
  end

  # private

  def command(cmd)
    debug("-- Running command: #{cmd}")
    system(cmd)
  end

  def command_output(cmd)
    debug("-- Running command (capturing output): #{cmd}")
    `#{cmd}`
  end

  def service_name
    name_found? ?
      "proc-shopify--#{input_name}@server.service" :
      "proc-shopify--shopify@server.service"
  end

  def name_found?
    input_name && matching_names.any?
  end

  def matching_names
    command_output("systemctl status \"*#{input_name}*\"")
      .split("\n")
      .filter { |line| line.match("‚óè")}
  end

  def input_name
    @argv.first
  end

  def additional_args
    @argv.drop(1).join(" ")
  end

  def has_journalfmt?
    command("ls #{journalfmt}")
  end

  def journalfmt
    "/opt/spin/bin/journalfmt"
  end
end

JournalService.call
